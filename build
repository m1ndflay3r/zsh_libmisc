#!/usr/bin/env zsh

BUILDOP="$@[1]"

rm -rf ./*.zwc &> /dev/null
if ls -a libmisc &> /dev/null; then
  rm -rf libmisc*
fi

func_incl_busybox() {
  cat zsh/extra/busybox > zsh/comp/busybox
  echo "autoload busybox" >> zsh/comp/libmiscinit
}

extra_module_handle() {
  IFS=$' '
  for zlibmisc_extra_opts in $=zlibmisc_incl_extra; do
    case $zlibmisc_extra_opts in
      (busybox) func_incl_busybox ;;
      (*) echo "extra module $zlibmisc_extra_opts does not exist"
    esac
  done
  unset IFS
}

libmiscinit_backup_handle() {
  if ! ls -a zsh/.libmiscinit.bak &> /dev/null; then
    cat zsh/comp/libmiscinit > zsh/.libmiscinit.bak
  else
    cat zsh/.libmiscinit.bak > zsh/comp/libmiscinit
  fi
}

if [ -z "$BUILDOP" ] || [ "$BUILDOP" = --dynamic ]; then
  libmiscinit_backup_handle
  if [ ! -z "$zlibmisc_incl_extra" ]; then
    extra_module_handle
  fi
  print '}' >> zsh/comp/libmiscinit
  zcompile -MU libmisc zsh/comp/*
elif [ "$BUILDOP" = --static ]; then
  libmiscinit_backup_handle
  if [ ! -z "$zlibmisc_incl_extra" ]; then
    extra_module_handle
  fi
  echo -n > libmisc
  echo '#!/usr/bin/env zsh' >> libmisc
  print '}' >> zsh/comp/libmiscinit
  cat zsh/comp/* >> libmisc
  zcompile -RU libmisc
fi
